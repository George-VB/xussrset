 /// code definition - mu

/*
NB: In fact, option _c is not checked, only _m and [not _m] are checked, which allows consist to have any alternatives instead
of _c, that is not correct. It would be more correct to check them and issue some large number as an error if there is
a mismatch (not done yet)
NB: it is not the best solution to hardcode the car's types as _h, _m, _c, they should be passed in parameters (appropriate
names should look like _cmp for _m with pantograph). This problem can be solved by 2setdiff templates, which provide
sets of names of all parts. Technically it can be used with incomplete sets, including the single set itself,
using it also for the second set, since the calculation of the number of ids is carried out outside the template,
and duplicates can be prevented there.
*/

// TODO suffix is not required where vehids is used, because a name is not used as ID. To remove

// EMU configuration calculation template

#define EMU_attach_calculation_template(name, vehid_h, vehid_m, vehid_c)                     \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template12,                             \
[  set_offset_to(num_vehs_in_consist-24),                                                    \
   STORE_TEMP(2048 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(12 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) ])          \
{  name##_can_attach_wagon_max; }                                                            \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template11,                             \
[  set_offset_to(num_vehs_in_consist-22),                                                    \
   STORE_TEMP(1024 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(11 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template12; }                                                   \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template10,                             \
[  set_offset_to(num_vehs_in_consist-20),                                                    \
   STORE_TEMP(512 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(10 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template11; }                                                   \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template9,                              \
[  set_offset_to(num_vehs_in_consist-18),                                                    \
   STORE_TEMP(256 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(9 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template10; }                                                   \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template8,                              \
[  set_offset_to(num_vehs_in_consist-16),                                                    \
   STORE_TEMP(128 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(8 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template9; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template7,                              \
[  set_offset_to(num_vehs_in_consist-14),                                                    \
   STORE_TEMP(64 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(7 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template8; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template6,                              \
[  set_offset_to(num_vehs_in_consist-12),                                                    \
   STORE_TEMP(32 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(6 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template7; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template5,                              \
[  set_offset_to(num_vehs_in_consist-10),                                                    \
   STORE_TEMP(16 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(5 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template6; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template4,                              \
[  set_offset_to(num_vehs_in_consist-8),                                                     \
   STORE_TEMP(8 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(4 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template5; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template3,                              \
[  set_offset_to(num_vehs_in_consist-6),                                                     \
   STORE_TEMP(4 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(3 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template4; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template2,                              \
[  set_offset_to(num_vehs_in_consist-4),                                                     \
   STORE_TEMP(2 * (prev_vehicle_type_id() == vehid_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(2 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template3; }                                                    \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template,                               \
[  set_offset_to(num_vehs_in_consist-2),                                                     \
   STORE_TEMP(1 * (prev_vehicle_type_id() == vehid_m), 5),                                   \
   STORE_TEMP(1 * 4096 * (prev_vehicle_type_id() == vehid_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                            \
     name##_can_attach_wagon_template2; }                                                    \

// EMU configuration calculation template with 2 types of head cars

#define EMU_attach_calculation_template2(name, suffix)                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template12,                      \
[  set_offset_to(num_vehs_in_consist-24),                                                     \
   STORE_TEMP(2048 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(12 * 65536 * (prev_vehicle_type_id() == name##_hm) +                            \
              12 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) ])          \
{  name##suffix##_can_attach_wagon_max; }                                                     \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template11,                      \
[  set_offset_to(num_vehs_in_consist-22),                                                     \
   STORE_TEMP(1024 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(11 * 65536 * (prev_vehicle_type_id() == name##_hm) +                            \
              11 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template12; }                                            \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template10,                      \
[  set_offset_to(num_vehs_in_consist-20),                                                     \
   STORE_TEMP(512 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(10 * 65536 * (prev_vehicle_type_id() == name##_hm) +                            \
              10 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template11; }                                            \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template9,                       \
[  set_offset_to(num_vehs_in_consist-18),                                                     \
   STORE_TEMP(256 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(9 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              9 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template10; }                                            \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template8,                       \
[  set_offset_to(num_vehs_in_consist-16),                                                     \
   STORE_TEMP(128 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(8 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              8 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template9; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template7,                       \
[  set_offset_to(num_vehs_in_consist-14),                                                     \
   STORE_TEMP(64 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(7 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              7 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template8; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template6,                       \
[  set_offset_to(num_vehs_in_consist-12),                                                     \
   STORE_TEMP(32 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(6 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              6 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template7; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template5,                       \
[  set_offset_to(num_vehs_in_consist-10),                                                     \
   STORE_TEMP(16 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(5 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              5 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template6; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template4,                       \
[  set_offset_to(num_vehs_in_consist-8),                                                      \
   STORE_TEMP(8 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(4 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              4 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template5; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template3,                       \
[  set_offset_to(num_vehs_in_consist-6),                                                      \
   STORE_TEMP(4 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(3 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              3 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template4; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template2,                       \
[  set_offset_to(num_vehs_in_consist-4),                                                      \
   STORE_TEMP(2 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(2 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              2 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template3; }                                             \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template,                        \
[  set_offset_to(num_vehs_in_consist-2),                                                      \
   STORE_TEMP(1 * (prev_vehicle_type_id() == name##_m), 5),                                   \
   STORE_TEMP(1 * 65536 * (prev_vehicle_type_id() == name##_hm) +                             \
              1 * 4096 * (prev_vehicle_type_id() == name##_h) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                     \
     name##suffix##_can_attach_wagon_template2; }                                             \

// EMU configuration calculation template with one alternative set

#define EMU_attach_calculation_template2set(name, suffix, name2)                                                                         \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template12,                                                                 \
[  set_offset_to(num_vehs_in_consist-24),                                                                                                \
   STORE_TEMP(2048 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(12 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) ])          \
{  name##suffix##_can_attach_wagon_max; }                                                                                                \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template11,                                                                 \
[  set_offset_to(num_vehs_in_consist-22),                                                                                                \
   STORE_TEMP(1024 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(11 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template12; }                                                                                       \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template10,                                                                 \
[  set_offset_to(num_vehs_in_consist-20),                                                                                                \
   STORE_TEMP(512 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(10 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template11; }                                                                                       \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template9,                                                                  \
[  set_offset_to(num_vehs_in_consist-18),                                                                                                \
   STORE_TEMP(256 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(9 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template10; }                                                                                       \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template8,                                                                  \
[  set_offset_to(num_vehs_in_consist-16),                                                                                                \
   STORE_TEMP(128 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(8 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template9; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template7,                                                                  \
[  set_offset_to(num_vehs_in_consist-14),                                                                                                \
   STORE_TEMP(64 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(7 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template8; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template6,                                                                  \
[  set_offset_to(num_vehs_in_consist-12),                                                                                                \
   STORE_TEMP(32 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(6 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template7; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template5,                                                                  \
[  set_offset_to(num_vehs_in_consist-10),                                                                                                \
   STORE_TEMP(16 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(5 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template6; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template4,                                                                  \
[  set_offset_to(num_vehs_in_consist-8),                                                                                                 \
   STORE_TEMP(8 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(4 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template5; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template3,                                                                  \
[  set_offset_to(num_vehs_in_consist-6),                                                                                                 \
   STORE_TEMP(4 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(3 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template4; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template2,                                                                  \
[  set_offset_to(num_vehs_in_consist-4),                                                                                                 \
   STORE_TEMP(2 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(2 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template3; }                                                                                        \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template,                                                                   \
[  set_offset_to(num_vehs_in_consist-2),                                                                                                 \
   STORE_TEMP(1 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)), 5),                                   \
   STORE_TEMP(1 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                                \
     name##suffix##_can_attach_wagon_template2; }                                                                                        \

// EMU configuration calculation template with one alternative set with specified names (NB: _c are not used yet)

#define EMU_attach_calculation_template2setdiff(name, vehid1_h, vehid1_m, vehid1_c, vehid2_h, vehid2_m, vehid2_c)                       \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template12,                                                                        \
[  set_offset_to(num_vehs_in_consist-24),                                                                                               \
   STORE_TEMP(2048 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(12 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) ])          \
{  name##_can_attach_wagon_max; }                                                                                                       \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template11,                                                                        \
[  set_offset_to(num_vehs_in_consist-22),                                                                                               \
   STORE_TEMP(1024 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(11 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template12; }                                                                                              \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template10,                                                                        \
[  set_offset_to(num_vehs_in_consist-20),                                                                                               \
   STORE_TEMP(512 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(10 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])  \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template11; }                                                                                              \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template9,                                                                         \
[  set_offset_to(num_vehs_in_consist-18),                                                                                               \
   STORE_TEMP(256 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(9 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template10; }                                                                                              \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template8,                                                                         \
[  set_offset_to(num_vehs_in_consist-16),                                                                                               \
   STORE_TEMP(128 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(8 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template9; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template7,                                                                         \
[  set_offset_to(num_vehs_in_consist-14),                                                                                               \
   STORE_TEMP(64 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(7 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template8; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template6,                                                                         \
[  set_offset_to(num_vehs_in_consist-12),                                                                                               \
   STORE_TEMP(32 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(6 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template7; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template5,                                                                         \
[  set_offset_to(num_vehs_in_consist-10),                                                                                               \
   STORE_TEMP(16 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(5 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template6; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template4,                                                                         \
[  set_offset_to(num_vehs_in_consist-8),                                                                                                \
   STORE_TEMP(8 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(4 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template5; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template3,                                                                         \
[  set_offset_to(num_vehs_in_consist-6),                                                                                                \
   STORE_TEMP(4 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(3 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template4; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template2,                                                                         \
[  set_offset_to(num_vehs_in_consist-4),                                                                                                \
   STORE_TEMP(2 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(2 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template3; }                                                                                               \
switch (FEAT_TRAINS, PARENT, name##_can_attach_wagon_template,                                                                          \
[  set_offset_to(num_vehs_in_consist-2),                                                                                                \
   STORE_TEMP(1 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)), 5),                                   \
   STORE_TEMP(1 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)) + LOAD_TEMP(5), 5) >= 4096 ])   \
{ 1: name##_can_attach_wagon_max;                                                                                                       \
     name##_can_attach_wagon_template2; }                                                                                               \

// EMU configuration calculation template 2bit with 4 head cars
// 0 - car
// 1 - car with pantograph
// 2 - motorized car
// 3 - motorized car with pantograph

#define EMU_attach_calculation_template2b(name, name_cp, name_mn, name_m, name_h, name_hp, name_hm, name_hmp, suffix)                \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template12,                                                             \
[  set_offset_to(num_vehs_in_consist-24),                                                                                            \
   STORE_TEMP(4194304 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                               \
   STORE_TEMP(12 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) ])              \
{  name##suffix##_can_attach_wagon_max; }                                                                                            \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template11,                                                             \
[  set_offset_to(num_vehs_in_consist-22),                                                                                            \
   STORE_TEMP(1048576 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                               \
   STORE_TEMP(11 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])  \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template12; }                                                                                   \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template10,                                                             \
[  set_offset_to(num_vehs_in_consist-20),                                                                                            \
   STORE_TEMP(262144 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                \
   STORE_TEMP(10 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])  \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template11; }                                                                                   \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template9,                                                              \
[  set_offset_to(num_vehs_in_consist-18),                                                                                            \
   STORE_TEMP(65536 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                 \
   STORE_TEMP(9 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template10; }                                                                                   \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template8,                                                              \
[  set_offset_to(num_vehs_in_consist-16),                                                                                            \
   STORE_TEMP(16384 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                 \
   STORE_TEMP(8 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template9; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template7,                                                              \
[  set_offset_to(num_vehs_in_consist-14),                                                                                            \
   STORE_TEMP(4096 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                  \
   STORE_TEMP(7 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template8; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template6,                                                              \
[  set_offset_to(num_vehs_in_consist-12),                                                                                            \
   STORE_TEMP(1024 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                  \
   STORE_TEMP(6 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template7; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template5,                                                              \
[  set_offset_to(num_vehs_in_consist-10),                                                                                            \
   STORE_TEMP(256 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                   \
   STORE_TEMP(5 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template6; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template4,                                                              \
[  set_offset_to(num_vehs_in_consist-8),                                                                                             \
   STORE_TEMP(64 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                    \
   STORE_TEMP(4 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template5; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template3,                                                              \
[  set_offset_to(num_vehs_in_consist-6),                                                                                             \
   STORE_TEMP(16 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                    \
   STORE_TEMP(3 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template4; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template2,                                                              \
[  set_offset_to(num_vehs_in_consist-4),                                                                                             \
   STORE_TEMP(4 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                                     \
   STORE_TEMP(2 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template3; }                                                                                    \
switch (FEAT_TRAINS, PARENT, name##suffix##_can_attach_wagon_template,                                                               \
[  set_offset_to(num_vehs_in_consist-2),                                                                                             \
   STORE_TEMP(1 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m), 5),                                                    \
   STORE_TEMP(1 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp) + LOAD_TEMP(5), 5) >= 16777216 ])   \
{ 1: name##suffix##_can_attach_wagon_max;                                                                                            \
     name##suffix##_can_attach_wagon_template2; }                                                                                    \

// EMU orientation calculation template

#define EMU_direction_calculation_template(name, suffix)                       \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template1,                 \
   STORE_TEMP(LOAD_TEMP(5) + LOAD_TEMP(6), 5))                                 \
{  name##suffix##_direction_max; }                                             \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back12,           \
[  set_offset_to(24),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{  name##suffix##_direction_template1; }                                       \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back11,           \
[  set_offset_to(22),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back12; }                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back10,           \
[  set_offset_to(20),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back11; }                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back9,            \
[  set_offset_to(18),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back10; }                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back8,            \
[  set_offset_to(16),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back9; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back7,            \
[  set_offset_to(14),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back8; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back6,            \
[  set_offset_to(12),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back7; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back5,            \
[  set_offset_to(10),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back6; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back4,            \
[  set_offset_to(8),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back5; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back3,            \
[  set_offset_to(6),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back4; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back2,            \
[  set_offset_to(4),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back3; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back1,            \
[  set_offset_to(2),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back2; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back0,            \
[  set_offset_to(0),                                                           \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back1; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template12,                \
[  set_offset_to(-24),                                                         \
   STORE_TEMP(2048 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),  \
   STORE_TEMP(12 * 4096 * (prev_vehicle_type_id() == name##_h), 6) ])          \
{  name##suffix##_direction_template_back0; }                                  \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template11,                \
[  set_offset_to(-22),                                                         \
   STORE_TEMP(1024 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),  \
   STORE_TEMP(11 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])  \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template12; }                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template10,                \
[  set_offset_to(-20),                                                         \
   STORE_TEMP(512 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(10 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])  \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template11; }                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template9,                 \
[  set_offset_to(-18),                                                         \
   STORE_TEMP(256 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(9 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template10; }                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template8,                 \
[  set_offset_to(-16),                                                         \
   STORE_TEMP(128 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(8 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template9; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template7,                 \
[  set_offset_to(-14),                                                         \
   STORE_TEMP(64 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(7 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template8; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template6,                 \
[  set_offset_to(-12),                                                         \
   STORE_TEMP(32 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(6 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template7; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template5,                 \
[  set_offset_to(-10),                                                         \
   STORE_TEMP(16 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(5 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template6; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template4,                 \
[  set_offset_to(-8),                                                          \
   STORE_TEMP(8 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(4 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template5; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template3,                 \
[  set_offset_to(-6),                                                          \
   STORE_TEMP(4 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(3 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template4; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template2,                 \
[  set_offset_to(-4),                                                          \
   STORE_TEMP(2 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(2 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template3; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template,                  \
[  set_offset_to(-2),                                                          \
   STORE_TEMP(1 * (prev_vehicle_type_id() == name##_m), 5),                    \
   STORE_TEMP(1 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template2; }                                     \

// EMU orientation calculation template  with 2 types of head cars

#define EMU_direction_calculation_template2(name, suffix)                      \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template1,                 \
   STORE_TEMP(LOAD_TEMP(5) + LOAD_TEMP(6), 5))                                 \
{  name##suffix##_direction_max; }                                             \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back12,           \
[  set_offset_to(24),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{  name##suffix##_direction_template1; }                                       \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back11,           \
[  set_offset_to(22),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back12; }                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back10,           \
[  set_offset_to(20),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back11; }                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back9,            \
[  set_offset_to(18),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back10; }                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back8,            \
[  set_offset_to(16),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back9; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back7,            \
[  set_offset_to(14),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back8; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back6,            \
[  set_offset_to(12),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back7; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back5,            \
[  set_offset_to(10),                                                          \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back6; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back4,            \
[  set_offset_to(8),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back5; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back3,            \
[  set_offset_to(6),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back4; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back2,            \
[  set_offset_to(4),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back3; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back1,            \
[  set_offset_to(2),                                                           \
   STORE_TEMP((LOAD_TEMP(7) == name##_m) + (2 * LOAD_TEMP(5)), 5),             \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back2; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back0,            \
[  set_offset_to(0),                                                           \
   STORE_TEMP(prev_vehicle_type_id(), 7) == name##_h ])                        \
{ 1: name##suffix##_direction_template1;                                       \
     name##suffix##_direction_template_back1; }                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template12,                \
[  set_offset_to(-24),                                                         \
   STORE_TEMP(2048 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),  \
   STORE_TEMP(12 * 65536 * (prev_vehicle_type_id() == name##_hm) +             \
              12 * 4096 * (prev_vehicle_type_id() == name##_h), 6) ])          \
{  name##suffix##_direction_template_back0; }                                  \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template11,                \
[  set_offset_to(-22),                                                         \
   STORE_TEMP(1024 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),  \
   STORE_TEMP(11 * 65536 * (prev_vehicle_type_id() == name##_hm) +             \
              11 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])  \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template12; }                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template10,                \
[  set_offset_to(-20),                                                         \
   STORE_TEMP(512 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(10 * 65536 * (prev_vehicle_type_id() == name##_hm) +             \
              10 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])  \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template11; }                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template9,                 \
[  set_offset_to(-18),                                                         \
   STORE_TEMP(256 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(9 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              9 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template10; }                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template8,                 \
[  set_offset_to(-16),                                                         \
   STORE_TEMP(128 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(8 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              8 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template9; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template7,                 \
[  set_offset_to(-14),                                                         \
   STORE_TEMP(64 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(7 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              7 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template8; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template6,                 \
[  set_offset_to(-12),                                                         \
   STORE_TEMP(32 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(6 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              6 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template7; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template5,                 \
[  set_offset_to(-10),                                                         \
   STORE_TEMP(16 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(5 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              5 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template6; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template4,                 \
[  set_offset_to(-8),                                                          \
   STORE_TEMP(8 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(4 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              4 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template5; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template3,                 \
[  set_offset_to(-6),                                                          \
   STORE_TEMP(4 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(3 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              3 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template4; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template2,                 \
[  set_offset_to(-4),                                                          \
   STORE_TEMP(2 * (prev_vehicle_type_id() == name##_m) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(2 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              2 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template3; }                                     \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template,                  \
[  set_offset_to(-2),                                                          \
   STORE_TEMP(1 * (prev_vehicle_type_id() == name##_m), 5),                    \
   STORE_TEMP(1 * 65536 * (prev_vehicle_type_id() == name##_hm) +              \
              1 * 4096 * (prev_vehicle_type_id() == name##_h), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                  \
     name##suffix##_direction_template2; }                                     \

// EMU orientation calculation template with one alternative set

#define EMU_direction_calculation_template2set(name, suffix, name2)                                                       \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template1,                                                            \
   STORE_TEMP(LOAD_TEMP(5) + LOAD_TEMP(6), 5))                                                                            \
{  name##suffix##_direction_max; }                                                                                        \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back12,                                                      \
[  set_offset_to(24),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{  name##suffix##_direction_template1; }                                                                                  \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back11,                                                      \
[  set_offset_to(22),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back12; }                                                                          \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back10,                                                      \
[  set_offset_to(20),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back11; }                                                                          \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back9,                                                       \
[  set_offset_to(18),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back10; }                                                                          \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back8,                                                       \
[  set_offset_to(16),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back9; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back7,                                                       \
[  set_offset_to(14),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back8; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back6,                                                       \
[  set_offset_to(12),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back7; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back5,                                                       \
[  set_offset_to(10),                                                                                                     \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back6; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back4,                                                       \
[  set_offset_to(8),                                                                                                      \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back5; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back3,                                                       \
[  set_offset_to(6),                                                                                                      \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back4; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back2,                                                       \
[  set_offset_to(4),                                                                                                      \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back3; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back1,                                                       \
[  set_offset_to(2),                                                                                                      \
   STORE_TEMP(((LOAD_TEMP(7) == name##_m) || (LOAD_TEMP(7) == name2##_m)) + (2 * LOAD_TEMP(5)), 5),                       \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back2; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back0,                                                       \
[  set_offset_to(0),                                                                                                      \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                 \
   ((LOAD_TEMP(7) == name##_h) || (LOAD_TEMP(7) == name2##_h)) ])                                                         \
{ 1: name##suffix##_direction_template1;                                                                                  \
     name##suffix##_direction_template_back1; }                                                                           \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template12,                                                           \
[  set_offset_to(-24),                                                                                                    \
   STORE_TEMP(2048 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),  \
   STORE_TEMP(12 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) ])          \
{  name##suffix##_direction_template_back0; }                                                                             \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template11,                                                           \
[  set_offset_to(-22),                                                                                                    \
   STORE_TEMP(1024 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),  \
   STORE_TEMP(11 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])  \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template12; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template10,                                                           \
[  set_offset_to(-20),                                                                                                    \
   STORE_TEMP(512 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(10 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])  \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template11; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template9,                                                            \
[  set_offset_to(-18),                                                                                                    \
   STORE_TEMP(256 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(9 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template10; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template8,                                                            \
[  set_offset_to(-16),                                                                                                    \
   STORE_TEMP(128 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),   \
   STORE_TEMP(8 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template9; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template7,                                                            \
[  set_offset_to(-14),                                                                                                    \
   STORE_TEMP(64 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(7 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template8; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template6,                                                            \
[  set_offset_to(-12),                                                                                                    \
   STORE_TEMP(32 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(6 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template7; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template5,                                                            \
[  set_offset_to(-10),                                                                                                    \
   STORE_TEMP(16 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),    \
   STORE_TEMP(5 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template6; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template4,                                                            \
[  set_offset_to(-8),                                                                                                     \
   STORE_TEMP(8 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(4 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template5; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template3,                                                            \
[  set_offset_to(-6),                                                                                                     \
   STORE_TEMP(4 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(3 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template4; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template2,                                                            \
[  set_offset_to(-4),                                                                                                     \
   STORE_TEMP(2 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)) + LOAD_TEMP(5), 5),     \
   STORE_TEMP(2 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template3; }                                                                                \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template,                                                             \
[  set_offset_to(-2),                                                                                                     \
   STORE_TEMP(1 * ((prev_vehicle_type_id() == name##_m) || (prev_vehicle_type_id() == name2##_m)), 5),                    \
   STORE_TEMP(1 * 4096 * ((prev_vehicle_type_id() == name##_h) || (prev_vehicle_type_id() == name2##_h)), 6) >= 4096 ])   \
{ 1: name##suffix##_direction_template_back0;                                                                             \
     name##suffix##_direction_template2; }                                                                                \

// EMU orientation calculation template with one alternative set with specified names (NB: _c are not used yet)

#define EMU_direction_calculation_template2setdiff(name, suffix, vehid1_h, vehid1_m, vehid1_c, vehid2_h, vehid2_m, vehid2_c)  \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template1,                                                                \
   STORE_TEMP(LOAD_TEMP(5) + LOAD_TEMP(6), 5))                                                                                \
{  name##suffix##_direction_max; }                                                                                            \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back12,                                                          \
[  set_offset_to(24),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{  name##suffix##_direction_template1; }                                                                                      \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back11,                                                          \
[  set_offset_to(22),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back12; }                                                                              \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back10,                                                          \
[  set_offset_to(20),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back11; }                                                                              \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back9,                                                           \
[  set_offset_to(18),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back10; }                                                                              \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back8,                                                           \
[  set_offset_to(16),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back9; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back7,                                                           \
[  set_offset_to(14),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back8; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back6,                                                           \
[  set_offset_to(12),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back7; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back5,                                                           \
[  set_offset_to(10),                                                                                                         \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back6; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back4,                                                           \
[  set_offset_to(8),                                                                                                          \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back5; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back3,                                                           \
[  set_offset_to(6),                                                                                                          \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back4; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back2,                                                           \
[  set_offset_to(4),                                                                                                          \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back3; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back1,                                                           \
[  set_offset_to(2),                                                                                                          \
   STORE_TEMP(((LOAD_TEMP(7) == vehid1_m) || (LOAD_TEMP(7) == vehid2_m)) + (2 * LOAD_TEMP(5)), 5),                            \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back2; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template_back0,                                                           \
[  set_offset_to(0),                                                                                                          \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                                     \
   ((LOAD_TEMP(7) == vehid1_h) || (LOAD_TEMP(7) == vehid2_h)) ])                                                              \
{ 1: name##suffix##_direction_template1;                                                                                      \
     name##suffix##_direction_template_back1; }                                                                               \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template12,                                                               \
[  set_offset_to(-24),                                                                                                        \
   STORE_TEMP(2048 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),       \
   STORE_TEMP(12 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) ])               \
{  name##suffix##_direction_template_back0; }                                                                                 \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template11,                                                               \
[  set_offset_to(-22),                                                                                                        \
   STORE_TEMP(1024 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),       \
   STORE_TEMP(11 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])       \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template12; }                                                                                   \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template10,                                                               \
[  set_offset_to(-20),                                                                                                        \
   STORE_TEMP(512 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),        \
   STORE_TEMP(10 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])       \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template11; }                                                                                   \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template9,                                                                \
[  set_offset_to(-18),                                                                                                        \
   STORE_TEMP(256 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),        \
   STORE_TEMP(9 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template10; }                                                                                   \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template8,                                                                \
[  set_offset_to(-16),                                                                                                        \
   STORE_TEMP(128 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),        \
   STORE_TEMP(8 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template9; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template7,                                                                \
[  set_offset_to(-14),                                                                                                        \
   STORE_TEMP(64 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),         \
   STORE_TEMP(7 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template8; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template6,                                                                \
[  set_offset_to(-12),                                                                                                        \
   STORE_TEMP(32 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),         \
   STORE_TEMP(6 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template7; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template5,                                                                \
[  set_offset_to(-10),                                                                                                        \
   STORE_TEMP(16 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),         \
   STORE_TEMP(5 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template6; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template4,                                                                \
[  set_offset_to(-8),                                                                                                         \
   STORE_TEMP(8 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),          \
   STORE_TEMP(4 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template5; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template3,                                                                \
[  set_offset_to(-6),                                                                                                         \
   STORE_TEMP(4 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),          \
   STORE_TEMP(3 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template4; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template2,                                                                \
[  set_offset_to(-4),                                                                                                         \
   STORE_TEMP(2 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)) + LOAD_TEMP(5), 5),          \
   STORE_TEMP(2 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template3; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##suffix##_direction_template,                                                                 \
[  set_offset_to(-2),                                                                                                         \
   STORE_TEMP(1 * ((prev_vehicle_type_id() == vehid1_m) || (prev_vehicle_type_id() == vehid2_m)), 5),                         \
   STORE_TEMP(1 * 4096 * ((prev_vehicle_type_id() == vehid1_h) || (prev_vehicle_type_id() == vehid2_h)), 6) >= 4096 ])        \
{ 1: name##suffix##_direction_template_back0;                                                                                 \
     name##suffix##_direction_template2; }                                                                                    \

// EMU orientation calculation template 2bit with 4 head cars
// 0 - car
// 1 - car with pantograph
// 2 - motorized car
// 3 - motorized car with pantograph

#define EMU_direction_calculation_template2b(name, name_cp, name_mn, name_m, name_h, name_hp, name_hm, name_hmp)      \
switch (FEAT_TRAINS, SELF, name##_direction_template1,                                                                \
   STORE_TEMP(LOAD_TEMP(5) + LOAD_TEMP(6), 5))                                                                        \
{  name##_direction_max; }                                                                                            \
switch (FEAT_TRAINS, SELF, name##_direction_template_back12,                                                          \
[  set_offset_to(24),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{  name##_direction_template1; }                                                                                      \
switch (FEAT_TRAINS, SELF, name##_direction_template_back11,                                                          \
[  set_offset_to(22),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back12; }                                                                              \
switch (FEAT_TRAINS, SELF, name##_direction_template_back10,                                                          \
[  set_offset_to(20),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back11; }                                                                              \
switch (FEAT_TRAINS, SELF, name##_direction_template_back9,                                                           \
[  set_offset_to(18),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back10; }                                                                              \
switch (FEAT_TRAINS, SELF, name##_direction_template_back8,                                                           \
[  set_offset_to(16),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back9; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back7,                                                           \
[  set_offset_to(14),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back8; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back6,                                                           \
[  set_offset_to(12),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back7; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back5,                                                           \
[  set_offset_to(10),                                                                                                 \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back6; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back4,                                                           \
[  set_offset_to(8),                                                                                                  \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back5; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back3,                                                           \
[  set_offset_to(6),                                                                                                  \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back4; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back2,                                                           \
[  set_offset_to(4),                                                                                                  \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back3; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back1,                                                           \
[  set_offset_to(2),                                                                                                  \
   STORE_TEMP(calc_eq3(LOAD_TEMP(7), name_cp, name_mn, name_m) + (4 * LOAD_TEMP(5)), 5),                              \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back2; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template_back0,                                                           \
[  set_offset_to(0),                                                                                                  \
   STORE_TEMP(prev_vehicle_type_id(), 7),                                                                             \
   veh_in4(LOAD_TEMP(7), name_h, name_hp, name_hm, name_hmp) ])                                                       \
{ 1: name##_direction_template1;                                                                                      \
     name##_direction_template_back1; }                                                                               \
switch (FEAT_TRAINS, SELF, name##_direction_template12,                                                               \
[  set_offset_to(-24),                                                                                                \
   STORE_TEMP(4194304 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                \
   STORE_TEMP(12 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) ])              \
{  name##_direction_template_back0; }                                                                                 \
switch (FEAT_TRAINS, SELF, name##_direction_template11,                                                               \
[  set_offset_to(-22),                                                                                                \
   STORE_TEMP(1048576 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                \
   STORE_TEMP(11 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])  \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template12; }                                                                                   \
switch (FEAT_TRAINS, SELF, name##_direction_template10,                                                               \
[  set_offset_to(-20),                                                                                                \
   STORE_TEMP(262144 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                 \
   STORE_TEMP(10 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])  \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template11; }                                                                                   \
switch (FEAT_TRAINS, SELF, name##_direction_template9,                                                                \
[  set_offset_to(-18),                                                                                                \
   STORE_TEMP(65536 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(9 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template10; }                                                                                   \
switch (FEAT_TRAINS, SELF, name##_direction_template8,                                                                \
[  set_offset_to(-16),                                                                                                \
   STORE_TEMP(16384 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                  \
   STORE_TEMP(8 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template9; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template7,                                                                \
[  set_offset_to(-14),                                                                                                \
   STORE_TEMP(4096 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(7 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template8; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template6,                                                                \
[  set_offset_to(-12),                                                                                                \
   STORE_TEMP(1024 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                   \
   STORE_TEMP(6 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template7; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template5,                                                                \
[  set_offset_to(-10),                                                                                                \
   STORE_TEMP(256 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                    \
   STORE_TEMP(5 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template6; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template4,                                                                \
[  set_offset_to(-8),                                                                                                 \
   STORE_TEMP(64 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                     \
   STORE_TEMP(4 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template5; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template3,                                                                \
[  set_offset_to(-6),                                                                                                 \
   STORE_TEMP(16 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                     \
   STORE_TEMP(3 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template4; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template2,                                                                \
[  set_offset_to(-4),                                                                                                 \
   STORE_TEMP(4 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m) + LOAD_TEMP(5), 5),                      \
   STORE_TEMP(2 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template3; }                                                                                    \
switch (FEAT_TRAINS, SELF, name##_direction_template,                                                                 \
[  set_offset_to(-2),                                                                                                 \
   STORE_TEMP(1 * calc_eq3(prev_vehicle_type_id(), name_cp, name_mn, name_m), 5),                                     \
   STORE_TEMP(1 * 16777216 * veh_in4(prev_vehicle_type_id(), name_h, name_hp, name_hm, name_hmp), 6) >= 16777216 ])   \
{ 1: name##_direction_template_back0;                                                                                 \
     name##_direction_template2; }                                                                                    \

// end
