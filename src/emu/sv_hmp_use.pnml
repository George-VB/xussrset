// emu_sv_hmp

#define PROP_emu_sv_m_CF  8
#define PROP_emu_sv_m_RC  59
#define PROP_emu_sv_m_SD  PROP_emu_sv_h_SD
#define PROP_emu_sv_m_WT  59
#define PROP_emu_sv_m_TE  95.0
#define PROP_emu_sv_m_PR  680
#define PROP_emu_sv_m_CC  106

map_sprites(emu_sv_hmp_purchase_sprites, emu_sd_hmp_purchase_sprites)
map_sprites(emu_sv_hmp_mu_notpowered_sprites_left, emu_sd_hmp_v1_mu_notpowered_sprites_left)
map_sprites(emu_sv_hmp_mu_notpowered_sprites_right, emu_sd_hmp_v1_mu_notpowered_sprites_right)

switch (FEAT_TRAINS, SELF, emu_sv_hmp_mu_sprites_left,
  (cargo_subtype == 0xE0) * 3 +                     // 15/3DC
  ((cargo_subtype == 0xE1) && (is_ER3DC())) * 3 +   // 3DC
  ((cargo_subtype == 0xE1) && (not_ER3DC())) * 2 +  // not 3DC
  ((cargo_subtype < 0xE0) && (is_ER15DC())) * 1)    // 15DC
{ 0: emu_sd_hmp_v1_mu_normal_sprites_left;
  1: emu_sd_hmp_v1_mu_sprites_left;
  2: emu_sm_hmp_v1_mu_normal_sprites_left;
  3: emu_sm_hmp_v1_mu_sprites_left;
     align_12_sprites; }

switch (FEAT_TRAINS, SELF, emu_sv_hmp_mu_sprites_right,
  (cargo_subtype == 0xE0) * 3 +                     // 15/3DC
  ((cargo_subtype == 0xE1) && (is_ER3DC())) * 3 +   // 3DC
  ((cargo_subtype == 0xE1) && (not_ER3DC())) * 2 +  // not 3DC
  ((cargo_subtype < 0xE0) && (is_ER15DC())) * 1)    // 15DC
{ 0: emu_sd_hmp_v1_mu_normal_sprites_right;
  1: emu_sd_hmp_v1_mu_sprites_right;
  2: emu_sm_hmp_v1_mu_normal_sprites_right;
  3: emu_sm_hmp_v1_mu_sprites_right;
     align_12_sprites; }

// перехватить ветку верных голов и добавить на них доп. проверки
MU_power_template12(emu_sv_hmp, sr_type1947_h, sr_type1947_hb, sr_type1947_hmp,
                                         sr_type1951_h, sr_type1951_hb, sr_type1951_hmp,
                                         emu_sv_h, emu_sv_hb, emu_sv_hmp,
                                         emu_sv_h, emu_sv_hb, emu_sv_hmp)

engine_direction_template4(emu_sv_hmp, emu_sv_hmp,  sr_type1947_hmp, sr_type1951_hmp, emu_sv_hmp)
map_sprites(emu_sv_hmp_2_direction_template, emu_sv_hmp_sprites_start)

switch (FEAT_TRAINS, PARENT, emu_sv_hmp_2_next_can_attach_wagon_template,
  emu_s_count() < 3)
{ 1: type_head_motor_pant_head_add_optional;
     type_head_add_optional; }

MU_attach_wagon_icon_template12(emu_sv_hmp_2,
                                sr_type1947_h, sr_type1947_hb, sr_type1947_hmp,
                                sr_type1951_h, sr_type1951_hb, sr_type1951_hmp,
                                emu_sv_h, emu_sv_hb, emu_sv_hmp,
                                emu_sv_h, emu_sv_hb, emu_sv_hmp, type_head_motor_pant)

switch (FEAT_TRAINS, SELF, emu_sv_hmp_sprites_left_current,
  cargo_subtype + 256 * (current_year < 1946) + 256 * (1 - enable_icons))
{
  0x00: icon_sprites_15dc;
  0xE0: icon_sprites_ddc;
  0xE1: icon_sprites_3dc;
        dummy_sprites;
}

switch (FEAT_TRAINS, SELF, emu_sv_hmp_sprites_left_back,
[ STORE_TEMP(CB_FLAG_MORE_SPRITES | PALETTE_USE_DEFAULT, 0x100),
  cargo_subtype + 256 * (current_year < 1946) + 256 * (1 - enable_icons) ])
{
  0x00: icon_sprites_back1;
  0xE0: icon_sprites_back2;
  0xE1: icon_sprites_back1;
        dummy_sprites;
}

switch (FEAT_TRAINS, SELF, emu_sv_hmp_sprites_left_depot,
  getbits(extra_callback_info1, 8, 8))
{
  0: emu_sv_hmp_2_sprites_start_sp;
  1: emu_sv_hmp_sprites_left_back;
  2: emu_sv_hmp_sprites_left_current;
     return CB_FAILED;
}
switch (FEAT_TRAINS, SELF, emu_sv_hmp_direction_template,
  getbits(extra_callback_info1, 0, 8))
{
  0x10..0x1F: emu_sv_hmp_sprites_left_depot;
              emu_sv_hmp_2_sprites_start_sp;
}

long_vehicle_advanced(emu_sv_hmp, emu_sv_hmp_direction_template)

// пантографы симметричны, искрит второй
engine_electric1_1_effect(emu_sv_hmp_0_create_effect_sprites, 5)
engine_effects_MU_emu_s(emu_sv_hmp_0, emu_sv_hmp_0_create_effect_sprites_left)

     is_ER15DC_ds(emu_sv_hmp_2_create_effect, emu_sv_hmp_0_create_effect, return disable_create_effect())
  engine_change_refit(emu_sv_hmp_1_create_effect, emu_sv_hmp_2_create_effect, emu_sv_hmp_0_create_effect)

  is_ER3DC_ds(emu_sv_hmp_sr3_create_effect, emu_sv_hmp_0_create_effect, return disable_create_effect())
engine_change_refit_shift(emu_sv_hmp_create_effect, emu_sv_hmp_1_create_effect, emu_sv_hmp_sr3_create_effect, 1)

    engine_capacity_MU_emu_s(emu_sv_hmp_sd, PROP_emu_sv_m_CC)
    engine_capacity_MU_emu_s(emu_sv_hmp_sm, PROP_emu_sm_m_CC)
  engine_change_refit(emu_sv_hmp_1_cargo_capacity, emu_sv_hmp_sd_cargo_capacity, emu_sv_hmp_sm_cargo_capacity)

  engine_capacity_MU_emu_s(emu_sv_hmp_sm3, PROP_sr3_m_CC)
engine_change_refit_shift(emu_sv_hmp_cargo_capacity, emu_sv_hmp_1_cargo_capacity, emu_sv_hmp_sm3_cargo_capacity, 1)

        engine_power_MU_emu_s(emu_sv_hmp_0_DC_2, NO_POWER)
      engine_0_power_alt(emu_sv_hmp_0_DC, emu_sv_hmp_0_DC_2_power)

      engine_power_MU_emu_s(emu_sv_hmp_0_15DC, PROP_emu_sv_m_PR)
    is_ER15DC_ds(emu_sv_hmp_0_power, emu_sv_hmp_0_15DC_power, emu_sv_hmp_0_DC_power)

    engine_power_MU_emu_s(emu_sv_hmp_sm, PROP_emu_sm_m_PR)
  engine_change_refit(emu_sv_hmp_1_power, emu_sv_hmp_0_power, emu_sv_hmp_sm_power)

      engine_power_MU_emu_s(emu_sv_hmp_sr3_15DC_2, NO_POWER)
    engine_0_power_alt(emu_sv_hmp_sr3_15DC, emu_sv_hmp_sr3_15DC_2_power)

    engine_power_MU_emu_s(emu_sv_hmp_sr3_DC, PROP_sr3_m_PR)
  is_ER3DC_ds(emu_sv_hmp_sr3_power, emu_sv_hmp_sr3_DC_power, emu_sv_hmp_sr3_15DC_power)
engine_change_refit_shift(emu_sv_hmp_power, emu_sv_hmp_1_power, emu_sv_hmp_sr3_power, 1)

    engine_refit_cost_for_livery_change2(emu_sv_hmp_3, 6, 7)
  engine_refit_cost_for_range_livery_change(emu_sv_hmp_2, 0xE0, 0xE0, 6, emu_sv_hmp_3_refit_cost)
engine_refit_cost_for_range_livery_change(emu_sv_hmp, 0xE1, 0xE1, 4, emu_sv_hmp_2_refit_cost)

// TODO change running cost according to refit
RC_head_check_emu_s(emu_sv_hmp)
switch (FEAT_TRAINS, SELF, emu_sv_hmp_running_cost_factor,
[  STORE_TEMP(34, 0),  // Моторы
   STORE_TEMP(5, 1),   // Бригада
   STORE_TEMP(12, 2),  // Износ
   STORE_TEMP(0, 3),   // Сопровождение
   STORE_TEMP(8, 4),   // ТО
   STORE_TEMP(1, 5),   // Сертификация

   STORE_TEMP(PROP_emu_sv_m_SD, 6),                                  // Скорость
   STORE_TEMP(round(PROP_emu_sv_m_WT), 7),                           // Тара
   STORE_TEMP(round(PROP_emu_sv_m_WT + PROP_emu_sv_m_CC / 16), 8)])  // Максимальная масса
{ emu_sv_hmp_check_running_cost_factor; }

name_in_group_subgroup(emu_sv_hmp, string(STR_NAME_IN_GROUP, string(STR_NAME_EMU_S_SERIES), string(STR_NAME_SV_HMP)),
                                   string(STR_NAME_IN_GROUP, string(STR_NAME_EMU_S_SERIES), string(STR_LONGNAME_SV_HMP)),
                                   string(STR_NAME_SV))

hint_MU_with_sme_2fact(emu_sv_hmp_b1932,
     calc_loading(PROP_emu_sv_m_CC / (2 * DOUBLE_DOOR)),
     STR_PURCHASE_HINT_CAP_00033_VERY_FAST,
     STR_PURCHASE_HINT_ENGINE_TYPE_EMU_HMP_15DC,
     STR_SECTIONS_EMU_S, STR_NAME_SV,
     1929, 1934,
     fact_mytishchi(),
     string(STR_PURCHASE_HINT_FACTORY_DINAMO))
hint_MU_with_sme2_2fact(emu_sv_hmp_a1932,
     calc_loading(PROP_emu_sv_m_CC / (2 * DOUBLE_DOOR)),
     STR_PURCHASE_HINT_CAP_00033_VERY_FAST,
     STR_PURCHASE_HINT_ENGINE_TYPE_EMU_HMP_15DC,
     STR_SECTIONS_EMU_S, STR_NAME_SV, STR_NAME_SD,
     1929, 1934,
     fact_mytishchi(),
     string(STR_PURCHASE_HINT_FACTORY_DINAMO))
hint_MU_with_sme3_2fact_comment(emu_sv_hmp_a1946,
     calc_loading(PROP_emu_sv_m_CC / (2 * DOUBLE_DOOR)),
     STR_PURCHASE_HINT_CAP_00033_VERY_FAST,
     STR_PURCHASE_HINT_ENGINE_TYPE_EMU_HMP_15DC,
     STR_SECTIONS_EMU_S, STR_NAME_SV, STR_NAME_SD, STR_NAME_SR,
     1929, 1934,
     fact_mytishchi(),
     string(STR_PURCHASE_HINT_FACTORY_DINAMO),
     string(STR_PURCHASE_HINT_UPGRADE_AVAILABLE,
            string(STR_REFIT_FACTORY_GENERAL_TYPE_R, string(STR_NAME_SM), string(STR_ERDDC))))
hint_MU_with_sme3_2fact_comment(emu_sv_hmp_a1952,
     calc_loading(PROP_emu_sv_m_CC / (2 * DOUBLE_DOOR)),
     STR_PURCHASE_HINT_CAP_00033_VERY_FAST,
     STR_PURCHASE_HINT_ENGINE_TYPE_EMU_HMP_15DC,
     STR_SECTIONS_EMU_S, STR_NAME_SV, STR_NAME_SD, STR_NAME_SR,
     1929, 1934,
     fact_mytishchi(),
     string(STR_PURCHASE_HINT_FACTORY_DINAMO),
     string(STR_PURCHASE_HINT_UPGRADE_AVAILABLE,
            string(STR_REFIT_FACTORY_GENERAL_TYPE_R, string(STR_NAME_SM3), string(STR_ER3DC))))
hint_change_after3(emu_sv_hmp, 1932, 1946, 1952)

item (FEAT_TRAINS, emu_sv_hmp, 702) {
  property {
    name: string(STR_NAME_SV_HMP);
    vehicle_dates(1929, 1934, 20, 10, 8, PROP_emu_sv_m_CF)
    vehicle_emu(ddc, PROP_emu_sv_m_PR, PROP_emu_sv_m_WT, PROP_emu_sv_m_TE, PROP_emu_sv_m_CC, 2 * DOUBLE_DOOR, _lowspeed)
    vehicle_group(emu_sv_h)
  }
  graphics {
    purchase_menu(PROP_emu_sv_m_CF, PROP_emu_sv_m_RC, PROP_emu_sv_m_SD, PROP_emu_sv_m_WT, PROP_emu_sv_m_TE, PROP_emu_sv_m_PR, PROP_emu_sv_m_CC)
        additional_text: emu_sv_hmp_additional_text;
       articulated_part: articulated_part_dummy4;
       can_attach_wagon: emu_s_can_attach_wagon;
       cargo_age_period: return CAP_00033_VERY_FAST;
         cargo_capacity: emu_sv_hmp_cargo_capacity;
     cargo_subtype_text: emu_sv_cargo_subtype_text;
         colour_mapping: any_cc_colour;
          create_effect: emu_sv_hmp_create_effect;
                default: emu_sv_hmp_sprites;
                   name: emu_sv_hmp_name;
                  power: emu_sv_hmp_power;
               purchase: emu_sv_hmp_purchase_sprites;
             refit_cost: emu_sv_hmp_refit_cost;
    running_cost_factor: emu_sv_hmp_running_cost_factor;
                  speed: return PROP_emu_sv_m_SD;
             start_stop: emu_s_start_stop;
  }
}

long_name_template(emu_sv_hmp, STR_LONGNAME_SV_HMP)
allow_dcemu(emu_sv_hmp)
